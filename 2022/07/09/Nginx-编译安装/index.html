

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" href="/img/favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="John Doe">
  <meta name="keywords" content="">
  
    <meta name="description" content="回顾上一节中，我们讲了[ https:&#x2F;&#x2F;slcnx.github.io&#x2F;2022&#x2F;06&#x2F;12&#x2F;vmware%E5%AE%89%E8%A3%85%E7%B3%BB%E7%BB%9F&#x2F; ], vmware安装规划中，如何单机部署, 高可用部署。 本节讲讲其中一个小服务nginx，nginx用来提供公司网页的，基于用户体验的过程的原理如下：  这里电脑从输入www.baidu.com到查看到百度，这一">
<meta property="og:type" content="article">
<meta property="og:title" content="Nginx-编译安装">
<meta property="og:url" content="http://example.com/2022/07/09/Nginx-%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85/index.html">
<meta property="og:site_name" content="my blog">
<meta property="og:description" content="回顾上一节中，我们讲了[ https:&#x2F;&#x2F;slcnx.github.io&#x2F;2022&#x2F;06&#x2F;12&#x2F;vmware%E5%AE%89%E8%A3%85%E7%B3%BB%E7%BB%9F&#x2F; ], vmware安装规划中，如何单机部署, 高可用部署。 本节讲讲其中一个小服务nginx，nginx用来提供公司网页的，基于用户体验的过程的原理如下：  这里电脑从输入www.baidu.com到查看到百度，这一">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/2022/07/09/Nginx-%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85/20220708133820.png">
<meta property="og:image" content="http://example.com/2022/07/09/Nginx-%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85/20220708163408.png">
<meta property="og:image" content="http://example.com/2022/07/09/Nginx-%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85/20220708171022.png">
<meta property="og:image" content="http://example.com/2022/07/09/Nginx-%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85/20220708165430.png">
<meta property="og:image" content="http://example.com/2022/07/09/Nginx-%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85/20220708172130.png">
<meta property="og:image" content="http://example.com/2022/07/09/Nginx-%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85/20220708210651.png">
<meta property="og:image" content="http://example.com/2022/07/09/Nginx-%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85/20220708214530.png">
<meta property="article:published_time" content="2022-07-09T21:46:41.000Z">
<meta property="article:modified_time" content="2022-09-29T01:02:42.399Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="linux">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://example.com/2022/07/09/Nginx-%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85/20220708133820.png">
  
  
  <title>Nginx-编译安装 - my blog</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4/github-markdown.min.css" />
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hint.css@2/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.css" />
  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.8.14","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":21348977,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.2"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Fluid</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                Home
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                Archives
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                Categories
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                Tags
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                About
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="Nginx-编译安装">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2022-07-09 21:46" pubdate>
        July 9, 2022 pm
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      14k 字
    </span>
  

  
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      119 分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">Nginx-编译安装</h1>
            
            <div class="markdown-body">
              <h1 id="回顾"><a href="#回顾" class="headerlink" title="回顾"></a>回顾</h1><p>上一节中，我们讲了[ <a target="_blank" rel="noopener" href="https://slcnx.github.io/2022/06/12/vmware%E5%AE%89%E8%A3%85%E7%B3%BB%E7%BB%9F/">https://slcnx.github.io/2022/06/12/vmware%E5%AE%89%E8%A3%85%E7%B3%BB%E7%BB%9F/</a> ], vmware安装规划中，如何单机部署, 高可用部署。 本节讲讲其中一个小服务nginx，nginx用来提供公司网页的，基于用户体验的过程的原理如下：</p>
<p><img src="20220708133820.png" srcset="/img/loading.gif" lazyload alt="image-20220708133818176"></p>
<p>这里电脑从输入<a href="http://www.baidu.com到查看到百度，这一个过程中，需要本地计算机**浏览器**发起http请求，请求支持http协议的**web服务器**，拿到http响应。http协议规范定义了**请求和响应**的格式，[">www.baidu.com到查看到百度，这一个过程中，需要本地计算机**浏览器**发起http请求，请求支持http协议的**web服务器**，拿到http响应。http协议规范定义了**请求和响应**的格式，[</a> <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Messages">https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Messages</a> ]， 而http协议是一种规范其实现是具体的软件，其客户端软件， 图形界面的浏览器(chrome, 360, firefox)，命令行的curl命令。而服务端软件有<code>httpd, nginx</code>。</p>
<p>我们在上一节中使用nginx作为静态站点，而没有使用apache的httpd，其原因就需要对比这两个软件的区别了。</p>
<h1 id="nginx和apache的区别"><a href="#nginx和apache的区别" class="headerlink" title="nginx和apache的区别"></a>nginx和apache的区别</h1><h2 id="请求到达服务器处理"><a href="#请求到达服务器处理" class="headerlink" title="请求到达服务器处理"></a>请求到达服务器处理</h2><p><img src="20220708163408.png" srcset="/img/loading.gif" lazyload alt="Nginx IO模型"></p>
<blockquote>
<p>参考: [ <a target="_blank" rel="noopener" href="https://www.modb.pro/db/401325">https://www.modb.pro/db/401325</a> ]</p>
</blockquote>
<p>浏览器请求到Linux服务器，基于请求的端口到达用户空间的进程，进程处理http协议的请求，基于URI解析协议, 域名，路径。从而找到对应的处理请求的配置，再加载合适的文件或代理到合适的后端应用服务器。</p>
<ul>
<li>动态请求，基于相应的协议获取数据。</li>
<li>静态请求，需要读磁盘上的文件，就需要发起系统调用，<strong>内核加载数据到内核空间，进程从内核空间将数据拷贝到用户空间</strong>。这个是一次文件IO</li>
</ul>
<p>请求到达用户空间的web进程的几种方式</p>
<ul>
<li><p><code>阻塞式IO</code></p>
<ul>
<li>请求数据未完全被内核加载到缓冲区时，进程是阻塞的。进程不占用CPU，并在等待队列中。直到数据加载完成，一次中断事件让内核把等待队列中的进程唤醒到达运行队列，这个时间进程才拿到数据，进行处理数据。</li>
<li>一个进程处理一个请求</li>
</ul>
</li>
<li><p><code>非阻塞IO</code></p>
<ul>
<li><p>进程调用函数时，只要未加载完成，就返回error。未加载完成就不是error, 处理数据。下面是模拟的代码，不是error处理数据，是error会做完其他事后再循环，浪费大量CPU进行查看数据是否完成。</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><pre><code class="hljs applescript"><span class="hljs-keyword">while</span> <span class="hljs-literal">true</span>; do <br>	<span class="hljs-keyword">if</span> [ `<span class="hljs-built_in">read</span>` !== “<span class="hljs-keyword">error</span><span class="hljs-string">&quot; ]; then</span><br><span class="hljs-string">		#处理数据</span><br><span class="hljs-string">	fi</span><br><span class="hljs-string">	# 做其他事</span><br><span class="hljs-string">done</span><br></code></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<p>由于阻塞式IO不能处理多个请求，所以有了IO多路复用，专用于处理多个请求，io多路复用，支持select/poll/epoll。</p>
<ul>
<li><code>select</code><ul>
<li>很多系统均支持</li>
<li>进程调用select之后，就和非阻塞IO一样，立即知道有没有数据。没有数据做其他的事。有数据就下一次问select时就拿到数据加载数据到内存，进行后续处理。</li>
<li>select就可以维护多个连接，使用一个数组，要知道数组中哪个连接有新的数据来，需要遍历一次数组，时间复杂度是O(n)。</li>
<li>select默认的连接上限1024</li>
</ul>
</li>
<li><code>poll</code><ul>
<li>windows不支持</li>
<li>维护多个连接是链表，没有连接上限。知道哪个连接有数据来是遍历，时间复杂 度是O(n)</li>
</ul>
</li>
<li><code>epoll</code><ul>
<li>进程调用epoll之后，会注册一个信号，这个信号函数会有后续的处理，所以当数据准备好之后，就调用进程的后续函数进行加载数据到用户空间的内存，再处理。</li>
<li>维护连接是hash表，知道哪个连接有数据来是遍历，时间复杂 度是O(1)。</li>
</ul>
</li>
</ul>
<p>以上5种IO模型，<strong>在内核准备数据时</strong>，<strong>进程</strong>除了第1个均是非阻塞，非阻塞中除了epoll 信号驱动之外均是同步，即进程轮轮循查看数据是否就绪。<strong>在数据准备好之后</strong>，均由各自函数加载数据到用户空间，进行处理。</p>
<p><img src="20220708171022.png" srcset="/img/loading.gif" lazyload alt="网络&amp;操作系统-linux五种IO模型| 池元烨的博客"></p>
<blockquote>
<p>引用自: [ <a target="_blank" rel="noopener" href="http://chiyuanye.com/2019/02/25/five-IO-models.html">http://chiyuanye.com/2019/02/25/five-IO-models.html</a> ]</p>
</blockquote>
<p>而<code>aio_read</code>这个函数是异步的，内核准备数据，数据加载到用户空间进程内存，均由内核完成，完成之后通知进程。进程进行后续操作。</p>
<h2 id="区别"><a href="#区别" class="headerlink" title="区别"></a>区别</h2><p>apache有2.2和2.4 这2个版本。均有3个处理模块,（ prefork, work, event ）。</p>
<ul>
<li>apache<ul>
<li>prefork, select IO模型</li>
<li>work, poll IO模型</li>
<li>event,  event IO模型</li>
</ul>
</li>
<li>nginx <ul>
<li>aio_read</li>
</ul>
</li>
</ul>
<p>nignx特点： <strong>异步非阻塞IO</strong>，<strong>解决C10K问题</strong>（10K Connections），且是<strong>免费的、开源的、⾼性能的HTTP服务器</strong>和<strong>HTTP反向代理服务器</strong>、<strong>邮件代理服务器</strong>、以及<strong>TCP/UDP代理服务器</strong>。</p>
<p>Nginx的优势在于：<strong>反向代理</strong>，静态资源Web服务，rewrite规则，稳定性， 模块化设计，静态文件处理，内存消耗，节省带宽，稳定性高，支持热部署，可以高并发连接等优点。</p>
<p>Netcraft公司于1994年底在英国成⽴，多年来⼀直致⼒于互联⽹市场以及在线安全⽅⾯的咨询服务，其中在国际上最具影响⼒的当属其针对⽹站服务器，域名解析/主机提供商，以及SSL市场所做的客观严谨的分析研究。</p>
<p>[ <a target="_blank" rel="noopener" href="https://news.netcraft.com/">https://news.netcraft.com/</a> ] nginx 自19起始稳居第1。而之前一直是apache占主导地位。</p>
<p><img src="20220708165430.png" srcset="/img/loading.gif" lazyload alt="image-20220708165429539"></p>
<blockquote>
<p>引用自: [ <a target="_blank" rel="noopener" href="https://zhangzhuo.ltd/articles/2021/05/17/1621240754222.html">https://zhangzhuo.ltd/articles/2021/05/17/1621240754222.html</a> ]</p>
</blockquote>
<h1 id="nginx介绍"><a href="#nginx介绍" class="headerlink" title="nginx介绍"></a>nginx介绍</h1><p>模块化设计，较好的扩展性 高可靠性 支持热部署：不停机更新配置⽂件，升级版本，更换⽇志⽂件 低内存消耗：10000个keep-alive连接模式下的⾮活动连接，仅需2.5M内存 <em><strong>event</strong></em>-<em><strong>driven</strong></em>,<em><strong>aio</strong></em>,<em><strong>mmap</strong></em>，<em><strong>sendfile</strong></em> </p>
<blockquote>
<p><img src="20220708172130.png" srcset="/img/loading.gif" lazyload alt="image-20220708172129010"></p>
<p>mmap要比普通的read系统调用少了一次copy的过程。因为read调用，进程是无法直接访问kernel space的，所以在read系统调用返回前，内核需要将数据从内核复制到进程指定的buffer。但mmap之后，进程可以直接访问mmap的数据(page cache)。<strong>第2个阶段 kernel &gt; user space不需要了。</strong></p>
<p>引用自: [ <a target="_blank" rel="noopener" href="https://blog.csdn.net/universsky2015/article/details/115114706">https://blog.csdn.net/universsky2015/article/details/115114706</a> ]</p>
<p><em>作为web服务器的时候打开sendfile加快静态⽂件传输，指定是否使⽤sendfile系统调⽤来传输⽂件,sendfile通过DMA(直接内存访问)⽅式直接访问⽂件数据，并通过传输协议发送，从⽽避免了数据在内核缓冲区和⽤户缓冲区之间的拷⻉，操作效率很⾼，被称之为零拷⻉，从<strong>硬盘&gt;kernel&gt;user space封装&gt;kernel&gt;协议栈</strong>，直接到: <strong>硬盘&gt;&gt; kernel buffer (快速拷⻉到kernel socket buffer) &gt;&gt;协议栈。</strong></em></p>
</blockquote>
<h2 id="环境初始化"><a href="#环境初始化" class="headerlink" title="环境初始化"></a>环境初始化</h2><ol>
<li><p>准备nginx主机</p>
</li>
<li><p>实验归划</p>
<p><img src="20220708210651.png" srcset="/img/loading.gif" lazyload alt="image-20220708210648579"></p>
<table>
<thead>
<tr>
<th>IP</th>
<th>主机名</th>
<th>用途</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>172.16.100.100</td>
<td>template-centos.magedu.com</td>
<td>模板机</td>
<td></td>
</tr>
<tr>
<td>172.16.100.101</td>
<td>nginx-1.magedu.com</td>
<td></td>
<td></td>
</tr>
<tr>
<td>172.16.100.102</td>
<td>nginx-2.magedu.com</td>
<td></td>
<td></td>
</tr>
<tr>
<td>172.16.100.103</td>
<td>nginx-3.magedu.com</td>
<td></td>
<td></td>
</tr>
<tr>
<td>172.16.100.104</td>
<td>nginx-4.magedu.com</td>
<td></td>
<td></td>
</tr>
<tr>
<td>172.16.100.105</td>
<td>nginx-5.magedu.com</td>
<td></td>
<td></td>
</tr>
<tr>
<td>172.16.100.106</td>
<td>nginx-6.magedu.com</td>
<td></td>
<td></td>
</tr>
<tr>
<td>172.16.100.107</td>
<td>nginx-7.magedu.com</td>
<td></td>
<td></td>
</tr>
<tr>
<td>172.16.100.108</td>
<td>nginx-8.magedu.com</td>
<td></td>
<td></td>
</tr>
<tr>
<td>172.16.100.109</td>
<td>nginx-9.magedu.com</td>
<td></td>
<td></td>
</tr>
<tr>
<td>172.16.100.110</td>
<td>nginx-10.magedu.com</td>
<td></td>
<td></td>
</tr>
<tr>
<td>172.16.100.111</td>
<td>php-1.magedu.com</td>
<td></td>
<td></td>
</tr>
<tr>
<td>172.16.100.112</td>
<td>php-2.magedu.com</td>
<td></td>
<td></td>
</tr>
<tr>
<td>172.16.100.113</td>
<td>php-3.magedu.com</td>
<td></td>
<td></td>
</tr>
<tr>
<td>172.16.100.114</td>
<td>php-4.magedu.com</td>
<td></td>
<td></td>
</tr>
<tr>
<td>172.16.100.115</td>
<td>php-5.magedu.com</td>
<td></td>
<td></td>
</tr>
<tr>
<td>172.16.100.116</td>
<td>php-6.magedu.com</td>
<td></td>
<td></td>
</tr>
<tr>
<td>172.16.100.117</td>
<td>php-7.magedu.com</td>
<td></td>
<td></td>
</tr>
<tr>
<td>172.16.100.118</td>
<td>php-8.magedu.com</td>
<td></td>
<td></td>
</tr>
<tr>
<td>172.16.100.119</td>
<td>php-9.magedu.com</td>
<td></td>
<td></td>
</tr>
<tr>
<td>172.16.100.120</td>
<td>php-10.magedu.com</td>
<td></td>
<td></td>
</tr>
<tr>
<td>172.16.100.121</td>
<td>mysql-1.magedu.com</td>
<td></td>
<td></td>
</tr>
<tr>
<td>172.16.100.122</td>
<td>mysql-2.magedu.com</td>
<td></td>
<td></td>
</tr>
<tr>
<td>172.16.100.123</td>
<td>mysql-3.magedu.com</td>
<td></td>
<td></td>
</tr>
<tr>
<td>172.16.100.124</td>
<td>mysql-4.magedu.com</td>
<td></td>
<td></td>
</tr>
<tr>
<td>172.16.100.125</td>
<td>mysql-5.magedu.com</td>
<td></td>
<td></td>
</tr>
<tr>
<td>172.16.100.126</td>
<td>mysql-6.magedu.com</td>
<td></td>
<td></td>
</tr>
<tr>
<td>172.16.100.127</td>
<td>mysql-7.magedu.com</td>
<td></td>
<td></td>
</tr>
<tr>
<td>172.16.100.128</td>
<td>mysql-8.magedu.com</td>
<td></td>
<td></td>
</tr>
<tr>
<td>172.16.100.129</td>
<td>mysql-9.magedu.com</td>
<td></td>
<td></td>
</tr>
<tr>
<td>172.16.100.130</td>
<td>mysql-10.magedu.com</td>
<td></td>
<td></td>
</tr>
</tbody></table>
</li>
<li><p>准备网络, vmnet9, 172.16.0.0/16 网络。</p>
</li>
<li><p>克隆 最初，调整配置，快照初始，准备模板主机</p>
</li>
<li><p>初始化主机为模板主机。</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">bash init.sh <span class="hljs-attribute">--resourceslimit</span>=1 <span class="hljs-attribute">--kernelparams</span>=1 <span class="hljs-attribute">--basepkgs</span>=1 <span class="hljs-attribute">--chinese</span>=0  <span class="hljs-attribute">--eth0</span>=1 <span class="hljs-attribute">--umirror</span>=0    <span class="hljs-attribute">--port</span>=6655 <span class="hljs-attribute">--allow-root-login</span>=<span class="hljs-literal">yes</span> <span class="hljs-attribute">--allow-pass-login</span>=<span class="hljs-literal">yes</span> <span class="hljs-attribute">--root-password</span>=<span class="hljs-string">&#x27;#^DzGp)DIN+1M)&#x27;</span>  <span class="hljs-attribute">--hostname</span>=template-centos.magedu.com <span class="hljs-attribute">--ipaddr</span>=172.16.100.100 <span class="hljs-attribute">--netmask</span>=255.255.0.0 <span class="hljs-attribute">--gateway</span>=172.16.100.2 <span class="hljs-attribute">--dns</span>=223.6.6.6 <span class="hljs-attribute">--author</span>=songliangcheng <span class="hljs-attribute">--qq</span>=2192383945 <span class="hljs-attribute">--desc</span>=<span class="hljs-string">&quot;A test toy&quot;</span><br></code></pre></td></tr></table></figure>

<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">rm -f <span class="hljs-regexp">/etc/</span>sysconfig<span class="hljs-regexp">/network-scripts/i</span>fcfg-ens33<br>reboot<br></code></pre></td></tr></table></figure></li>
<li><p>修改网络</p>
</li>
<li><p>准备网关</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#准备网关，172.16.0.2</span><br>TYPE=Ethernet<br>BOOTPROTO=static<br>DEVICE=eth1<br>ONBOOT=<span class="hljs-built_in">yes</span><br>IPADDR=172.16.0.2<br>NETMASK=255.255.0.0<br></code></pre></td></tr></table></figure>

<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">sysctl</span> -w net.ipv4.ip_forward=<span class="hljs-number">1</span><br><span class="hljs-attribute">iptables</span> -t nat -I POSTROUTING -s <span class="hljs-number">172.16.0.0</span>/<span class="hljs-number">16</span> -o eth0  -j  MASQUERADE<br></code></pre></td></tr></table></figure>

<p>现在<code>ping www.baidu.com</code></p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs applescript"><span class="hljs-comment"># 本机看到</span><br>[root@template-centos ~]<span class="hljs-comment"># tcpdump -nn -vv -i eth0 icmp</span><br>tcpdump: listening <span class="hljs-keyword">on</span> eth0, link-type EN10MB (Ethernet), capture size <span class="hljs-number">262144</span> bytes<br><span class="hljs-number">20</span>:<span class="hljs-number">22</span>:<span class="hljs-number">32.070572</span> IP (tos <span class="hljs-number">0x0</span>, ttl <span class="hljs-number">64</span>, <span class="hljs-built_in">id</span> <span class="hljs-number">18283</span>, <span class="hljs-built_in">offset</span> <span class="hljs-number">0</span>, flags [DF], proto ICMP (<span class="hljs-number">1</span>), <span class="hljs-built_in">length</span> <span class="hljs-number">84</span>)<br>    <span class="hljs-number">172.16</span><span class="hljs-number">.100</span><span class="hljs-number">.100</span> &gt; <span class="hljs-number">110.242</span><span class="hljs-number">.68</span><span class="hljs-number">.4</span>: ICMP echo request, <span class="hljs-built_in">id</span> <span class="hljs-number">1485</span>, seq <span class="hljs-number">28</span>, <span class="hljs-built_in">length</span> <span class="hljs-number">64</span><br><span class="hljs-number">20</span>:<span class="hljs-number">22</span>:<span class="hljs-number">32.113527</span> IP (tos <span class="hljs-number">0x0</span>, ttl <span class="hljs-number">127</span>, <span class="hljs-built_in">id</span> <span class="hljs-number">30763</span>, <span class="hljs-built_in">offset</span> <span class="hljs-number">0</span>, flags [none], proto ICMP (<span class="hljs-number">1</span>), <span class="hljs-built_in">length</span> <span class="hljs-number">84</span>)<br>    <span class="hljs-number">110.242</span><span class="hljs-number">.68</span><span class="hljs-number">.4</span> &gt; <span class="hljs-number">172.16</span><span class="hljs-number">.100</span><span class="hljs-number">.100</span>: ICMP echo reply, <span class="hljs-built_in">id</span> <span class="hljs-number">1485</span>, seq <span class="hljs-number">28</span>, <span class="hljs-built_in">length</span> <span class="hljs-number">64</span><br><br><span class="hljs-comment"># 网关看到</span><br>    <span class="hljs-number">192.168</span><span class="hljs-number">.131</span><span class="hljs-number">.100</span> &gt; <span class="hljs-number">110.242</span><span class="hljs-number">.68</span><span class="hljs-number">.4</span>: ICMP echo request, <span class="hljs-built_in">id</span> <span class="hljs-number">1485</span>, seq <span class="hljs-number">62</span>, <span class="hljs-built_in">length</span> <span class="hljs-number">64</span><br><span class="hljs-number">20</span>:<span class="hljs-number">23</span>:<span class="hljs-number">06.167984</span> IP (tos <span class="hljs-number">0x0</span>, ttl <span class="hljs-number">128</span>, <span class="hljs-built_in">id</span> <span class="hljs-number">30800</span>, <span class="hljs-built_in">offset</span> <span class="hljs-number">0</span>, flags [none], proto ICMP (<span class="hljs-number">1</span>), <span class="hljs-built_in">length</span> <span class="hljs-number">84</span>)<br>    <span class="hljs-number">110.242</span><span class="hljs-number">.68</span><span class="hljs-number">.4</span> &gt; <span class="hljs-number">192.168</span><span class="hljs-number">.131</span><span class="hljs-number">.100</span>: ICMP echo reply, <span class="hljs-built_in">id</span> <span class="hljs-number">1485</span>, seq <span class="hljs-number">62</span>, <span class="hljs-built_in">length</span> <span class="hljs-number">64</span><br></code></pre></td></tr></table></figure>

<p>172.16.100.100 -&gt; 192.168.131.100 -&gt; 110.242.68.4 （修改源为网关的可以出去的IP）</p>
<p>172.16.100.100 &lt;- 192.168.131.100 &lt;- 110.242.68.4 ( 修改目标为内网IP)</p>
</li>
<li><p>重启验证ip, 域名解析, kernel params, crontab, ssh, alias</p>
</li>
<li><p>关机快照。template, </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-number">6655</span><br><span class="hljs-string">root</span><br><span class="hljs-comment">#^DzGp)DIN+1M)</span><br></code></pre></td></tr></table></figure></li>
</ol>
<p>准备第1个节点</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">bash init.sh --hostname=nginx-1.magedu.com --ipaddr=172.16.100.101 --netmask=255.255.0.0 --gateway=172.16.100.2 --dns=223.6.6.6 --root-password=<span class="hljs-string">&#x27;7HmqYhjwvNBuYW2X&#x27;</span><br>reboot<br>验证ip,网络, 主机名<br></code></pre></td></tr></table></figure>



<h2 id="编译安装nginx"><a href="#编译安装nginx" class="headerlink" title="编译安装nginx"></a>编译安装nginx</h2><p><a target="_blank" rel="noopener" href="https://nginx.org/en/download.html">https://nginx.org/en/download.html</a></p>
<p>Stable version  <a target="_blank" rel="noopener" href="https://nginx.org/download/nginx-1.22.0.tar.gz"> nginx-1.22.0</a></p>
<h3 id="制作rpm"><a href="#制作rpm" class="headerlink" title="制作rpm"></a>制作rpm</h3><p>进入nginx的源码仓库: [ <a target="_blank" rel="noopener" href="http://nginx.org/packages/centos/7Server/SRPMS/">http://nginx.org/packages/centos/7Server/SRPMS/</a> ]</p>
<p>下载安装geoip</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">wget</span> http://nginx.org/packages/centos/<span class="hljs-number">7</span>Server/SRPMS/nginx-module-geoip-<span class="hljs-number">1</span>.<span class="hljs-number">22</span>.<span class="hljs-number">0</span>-<span class="hljs-number">1</span>.el7.ngx.src.rpm<br><br><span class="hljs-attribute">rpm</span> -ivh nginx-module-geoip-<span class="hljs-number">1</span>.<span class="hljs-number">22</span>.<span class="hljs-number">0</span>-<span class="hljs-number">1</span>.el7.ngx.src.rpm <br></code></pre></td></tr></table></figure>

<p>准备yum-utils</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">yum <span class="hljs-keyword">install </span>yum-utils rpm-<span class="hljs-keyword">build </span>-y<br></code></pre></td></tr></table></figure>

<p>构建rpm包</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> /root/rpmbuild/SPECS<br><span class="hljs-comment"># 安装依赖的模板</span><br><span class="hljs-comment"># yum-builddep nginx-module-geoip.spec   --downloadonly  --downloaddir=/root/pkgs </span><br><span class="hljs-comment"># ls /root/pkgs/ | xargs -I &#123;&#125; echo &#123;&#125; | sed &#x27;s@-[0-9].*@@&#x27; | xargs</span><br>cpp e2fsprogs e2fsprogs-libs gcc GeoIP GeoIP-devel geoipupdate glibc glibc-common glibc-devel glibc-headers kernel-headers keyutils-libs-devel krb5-devel krb5-libs libcom_err libcom_err-devel libgcc libgomp libkadm5 libmpc libselinux libselinux-devel libselinux-python libselinux-utils libsepol-devel libss libverto-devel mpfr openssl openssl-devel openssl-libs pcre2 pcre2-devel pcre2-utf16 pcre2-utf32 pcre-devel zlib zlib-devel<br> <br></code></pre></td></tr></table></figure>

<p> rpmbuild -bb nginx-module-geoip.spec </p>
<div class="code-wrapper"><pre><code class="hljs"># rpm
   [root@localhost SPECS]# ls ../RPMS/x86_64/
    nginx-module-geoip-1.22.0-1.el7.ngx.x86_64.rpm  nginx-module-geoip-debuginfo-1.22.0-1.el7.ngx.x86_64.rpm
rpmbuild -bb nginx
</code></pre></div>
<p>得到依赖</p>
<figure class="highlight nsis"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nsis">cpp e2fsprogs e2fsprogs-libs gcc GeoIP GeoIP-devel geoipupdate glibc glibc-common glibc-devel glibc-headers kernel-headers keyutils-libs-devel krb5-devel krb5-libs libcom_err libcom_err-devel libgcc libgomp libkadm5 libmpc libselinux libselinux-devel libselinux-python libselinux-utils libsepol-devel libss libverto-devel mpfr openssl openssl-devel openssl-libs pcre2 pcre2-devel pcre2-utf16 pcre2-utf32 pcre-devel <span class="hljs-literal">zlib</span> <span class="hljs-literal">zlib</span>-devel<br></code></pre></td></tr></table></figure>

<p>   安装rpm之后得到编译参数</p>
   <figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs clean">[root@localhost SPECS]# rpm -ivh ../RPMS/x86_64/nginx<span class="hljs-number">-1.22</span><span class="hljs-number">.0</span><span class="hljs-number">-1.</span>el7.ngx.x86_64.rpm <br>准备中...                          ################################# [<span class="hljs-number">100</span>%]<br>正在升级/安装...<br>   <span class="hljs-number">1</span>:nginx<span class="hljs-number">-1</span>:<span class="hljs-number">1.22</span><span class="hljs-number">.0</span><span class="hljs-number">-1.</span>el7.ngx         ################################# [<span class="hljs-number">100</span>%]<br>----------------------------------------------------------------------<br><br>Thanks for using nginx!<br><br>Please find the official documentation for nginx here:<br>* https:<span class="hljs-comment">//nginx.org/en/docs/</span><br><br>Please subscribe to nginx-announce mailing list to get<br>the most important news about nginx:<br>* https:<span class="hljs-comment">//nginx.org/en/support.html</span><br><br>Commercial subscriptions for nginx are available on:<br>* https:<span class="hljs-comment">//nginx.com/products/</span><br></code></pre></td></tr></table></figure>

<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs gradle">[root@localhost SPECS]# nginx -V<br>  nginx version: nginx/<span class="hljs-number">1.22</span>.<span class="hljs-number">0</span><br>  built by gcc <span class="hljs-number">4.8</span>.<span class="hljs-number">5</span> <span class="hljs-number">20150623</span> (Red Hat <span class="hljs-number">4.8</span>.<span class="hljs-number">5</span>-<span class="hljs-number">44</span>) (GCC) <br>  built with OpenSSL <span class="hljs-number">1.0</span>.<span class="hljs-number">2</span>k-fips  <span class="hljs-number">26</span> Jan <span class="hljs-number">2017</span><br>  TLS SNI support enabled<br>  configure arguments: --prefix=<span class="hljs-regexp">/etc/</span>nginx --sbin-path=<span class="hljs-regexp">/usr/</span>sbin<span class="hljs-regexp">/nginx --modules-path=/u</span>sr<span class="hljs-regexp">/lib64/</span>nginx<span class="hljs-regexp">/modules --conf-path=/</span>etc<span class="hljs-regexp">/nginx/</span>nginx.conf --error-log-path=<span class="hljs-regexp">/var/</span>log<span class="hljs-regexp">/nginx/</span>error.log --http-log-path=<span class="hljs-regexp">/var/</span>log<span class="hljs-regexp">/nginx/</span>access.log --pid-path=<span class="hljs-regexp">/var/</span>run<span class="hljs-regexp">/nginx.pid --lock-path=/</span>var<span class="hljs-regexp">/run/</span>nginx.lock --http-client-body-temp-path=<span class="hljs-regexp">/var/</span>cache<span class="hljs-regexp">/nginx/</span>client_temp --http-proxy-temp-path=<span class="hljs-regexp">/var/</span>cache<span class="hljs-regexp">/nginx/</span>proxy_temp --http-fastcgi-temp-path=<span class="hljs-regexp">/var/</span>cache<span class="hljs-regexp">/nginx/</span>fastcgi_temp --http-uwsgi-temp-path=<span class="hljs-regexp">/var/</span>cache<span class="hljs-regexp">/nginx/u</span>wsgi_temp --http-scgi-temp-path=<span class="hljs-regexp">/var/</span>cache<span class="hljs-regexp">/nginx/</span>scgi_temp --user=nginx --<span class="hljs-keyword">group</span>=nginx --with-compat --with-<span class="hljs-keyword">file</span>-aio --with-threads --with-http_addition_module --with-http_auth_request_module --with-http_dav_module --with-http_flv_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_mp4_module --with-http_random_index_module --with-http_realip_module --with-http_secure_link_module --with-http_slice_module --with-http_ssl_module --with-http_stub_status_module --with-http_sub_module --with-http_v2_module --with-mail --with-mail_ssl_module --with-stream --with-stream_realip_module --with-stream_ssl_module --with-stream_ssl_preread_module --with-cc-opt=<span class="hljs-string">&#x27;-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong --param=ssp-buffer-size=4 -grecord-gcc-switches -m64 -mtune=generic -fPIC&#x27;</span> --with-ld-opt=<span class="hljs-string">&#x27;-Wl,-z,relro -Wl,-z,now -pie&#x27;</span><br></code></pre></td></tr></table></figure>

<p>  抽取部分</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli"><span class="hljs-string">./configure</span> <span class="hljs-params">--prefix=/apps/nginx</span>    <span class="hljs-params">--user=nginx</span> <span class="hljs-params">--group=nginx</span> <span class="hljs-params">--with-compat</span> <span class="hljs-params">--with-file-aio</span> <span class="hljs-params">--with-threads</span> <span class="hljs-params">--with-http_addition_module</span> <span class="hljs-params">--with-http_auth_request_module</span>  <span class="hljs-params">--with-http_gunzip_module</span> <span class="hljs-params">--with-http_gzip_static_module</span> <span class="hljs-params">--with-http_random_index_module</span> <span class="hljs-params">--with-http_realip_module</span> <span class="hljs-params">--with-http_secure_link_module</span> <span class="hljs-params">--with-http_slice_module</span> <span class="hljs-params">--with-http_ssl_module</span> <span class="hljs-params">--with-http_stub_status_module</span> <span class="hljs-params">--with-http_sub_module</span> <span class="hljs-params">--with-http_v2_module</span>  <span class="hljs-params">--with-stream</span> <span class="hljs-params">--with-stream_realip_module</span> <span class="hljs-params">--with-stream_ssl_module</span> <span class="hljs-params">--with-stream_ssl_preread_module</span> <span class="hljs-params">--with-http_geoip_module=dynamic</span> <span class="hljs-params">--with-stream_geoip_module=dynamic</span><br></code></pre></td></tr></table></figure>



<h3 id="编译安装-ubuntu-centos均可"><a href="#编译安装-ubuntu-centos均可" class="headerlink" title="编译安装 (ubuntu/centos均可)"></a>编译安装 (ubuntu/centos均可)</h3>   <figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">[root@nginx-2 ~]<span class="hljs-comment"># tar xvf nginx-1.22.0.tar.gz -C /usr/local/src/</span><br><br>yum install cpp e2fsprogs e2fsprogs-libs gcc GeoIP GeoIP-devel geoipupdate glibc glibc-common glibc-devel glibc-headers kernel-headers keyutils-libs-devel krb5-devel krb5-libs libcom_err libcom_err-devel libgcc libgomp libkadm5 libmpc libselinux libselinux-devel libselinux-python libselinux-utils libsepol-devel libss libverto-devel mpfr openssl openssl-devel openssl-libs pcre2 pcre2-devel pcre2-utf16 pcre2-utf32 pcre-devel zlib zlib-devel -y<br><br><span class="hljs-string">./configure</span> <span class="hljs-params">--prefix=/apps/nginx</span>   \<br>	<span class="hljs-params">--user=nginx</span> <span class="hljs-params">--group=nginx</span> \<br>	<span class="hljs-params">--with-compat</span> <span class="hljs-params">--with-file-aio</span> <span class="hljs-params">--with-threads</span> \<br>	<span class="hljs-params">--with-http_addition_module</span> <span class="hljs-params">--with-http_auth_request_module</span>  <span class="hljs-params">--with-http_gunzip_module</span> <span class="hljs-params">--with-http_gzip_static_module</span> <span class="hljs-params">--with-http_random_index_module</span> \<br>	<span class="hljs-params">--with-http_realip_module</span> <span class="hljs-params">--with-http_secure_link_module</span> <span class="hljs-params">--with-http_slice_module</span> <span class="hljs-params">--with-http_ssl_module</span> \<br>	<span class="hljs-params">--with-http_stub_status_module</span> <span class="hljs-params">--with-http_sub_module</span> <span class="hljs-params">--with-http_v2_module</span>  \<br>	<span class="hljs-params">--with-stream</span> <span class="hljs-params">--with-stream_realip_module</span> <span class="hljs-params">--with-stream_ssl_module</span> <span class="hljs-params">--with-stream_ssl_preread_module</span> \<br>	<span class="hljs-params">--with-http_geoip_module=dynamic</span> <span class="hljs-params">--with-stream_geoip_module=dynamic</span><br><br></code></pre></td></tr></table></figure>

<p>你将看到以下输出 </p>
   <figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs livecodeserver">Configuration summary<br>  + <span class="hljs-keyword">using</span> threads<br>  + <span class="hljs-keyword">using</span> <span class="hljs-keyword">system</span> PCRE2 library<br>  + <span class="hljs-keyword">using</span> <span class="hljs-keyword">system</span> OpenSSL library<br>  + <span class="hljs-keyword">using</span> <span class="hljs-keyword">system</span> zlib library<br><br>  nginx path prefix: <span class="hljs-string">&quot;/apps/nginx&quot;</span><br>  nginx binary <span class="hljs-built_in">file</span>: <span class="hljs-string">&quot;/apps/nginx/sbin/nginx&quot;</span><br>  nginx modules path: <span class="hljs-string">&quot;/apps/nginx/modules&quot;</span><br>  nginx configuration prefix: <span class="hljs-string">&quot;/apps/nginx/conf&quot;</span><br>  nginx configuration <span class="hljs-built_in">file</span>: <span class="hljs-string">&quot;/apps/nginx/conf/nginx.conf&quot;</span><br>  nginx pid <span class="hljs-built_in">file</span>: <span class="hljs-string">&quot;/apps/nginx/logs/nginx.pid&quot;</span><br>  nginx error <span class="hljs-built_in">log</span> <span class="hljs-built_in">file</span>: <span class="hljs-string">&quot;/apps/nginx/logs/error.log&quot;</span><br>  nginx <span class="hljs-keyword">http</span> access <span class="hljs-built_in">log</span> <span class="hljs-built_in">file</span>: <span class="hljs-string">&quot;/apps/nginx/logs/access.log&quot;</span><br>  nginx <span class="hljs-keyword">http</span> client request body temporary <span class="hljs-built_in">files</span>: <span class="hljs-string">&quot;client_body_temp&quot;</span><br>  nginx <span class="hljs-keyword">http</span> proxy temporary <span class="hljs-built_in">files</span>: <span class="hljs-string">&quot;proxy_temp&quot;</span><br>  nginx <span class="hljs-keyword">http</span> fastcgi temporary <span class="hljs-built_in">files</span>: <span class="hljs-string">&quot;fastcgi_temp&quot;</span><br>  nginx <span class="hljs-keyword">http</span> uwsgi temporary <span class="hljs-built_in">files</span>: <span class="hljs-string">&quot;uwsgi_temp&quot;</span><br>  nginx <span class="hljs-keyword">http</span> scgi temporary <span class="hljs-built_in">files</span>: <span class="hljs-string">&quot;scgi_temp&quot;</span><br></code></pre></td></tr></table></figure>

<p>之后，编译安装</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">make -j $(<span class="hljs-built_in">nproc</span>) &amp;&amp; make install -j $(<span class="hljs-built_in">nproc</span>)<br></code></pre></td></tr></table></figure>

<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs autoit">[root<span class="hljs-symbol">@nginx</span><span class="hljs-number">-2</span> nginx<span class="hljs-number">-1.22</span><span class="hljs-number">.0</span>]<span class="hljs-meta"># cd /apps/nginx/</span><br>[root<span class="hljs-symbol">@nginx</span><span class="hljs-number">-2</span> nginx]<span class="hljs-meta"># groupadd -g 2022 nginx</span><br>[root<span class="hljs-symbol">@nginx</span><span class="hljs-number">-2</span> nginx]<span class="hljs-meta"># useradd -u 2022 -s /sbin/nologin nginx -g nginx</span><br><br>[root<span class="hljs-symbol">@nginx</span><span class="hljs-number">-2</span> nginx]<span class="hljs-meta"># ./sbin/nginx -g <span class="hljs-string">&#x27;daemon off;&#x27;</span> # 需要在前台</span><br></code></pre></td></tr></table></figure>

<p>浏览器访问 <a target="_blank" rel="noopener" href="http://172.16.100.102/">http://172.16.100.102/</a></p>
<p><img src="20220708214530.png" srcset="/img/loading.gif" lazyload alt="image-20220708214528854"></p>
<p>ctrl c 终止后，准备服务脚本</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-comment"># 为当前nginx添加版本方便升级nginx, 回退</span><br>mv <span class="hljs-regexp">/apps/</span>nginx<span class="hljs-regexp">/ /</span>apps/nginx-<span class="hljs-number">1.22</span>.<span class="hljs-number">0</span><br><br><span class="hljs-comment"># 自动生成服务脚本 github</span><br>curl -L https:<span class="hljs-regexp">//</span>raw.githubusercontent.com<span class="hljs-regexp">/slcnx/</span>post-precompile<span class="hljs-regexp">/main/</span>post-precompile.sh | bash -s -- -ap <span class="hljs-regexp">/apps/</span>nginx-<span class="hljs-number">1.22</span>.<span class="hljs-number">0</span> -s <span class="hljs-string">&quot;./sbin/nginx -g &#x27;daemon off;&#x27;&quot;</span><br><br><span class="hljs-comment"># 自动生成服务脚本 gitee</span><br>curl -L https:<span class="hljs-regexp">//gi</span>tee.com<span class="hljs-regexp">/slcnx/</span>post-precompile<span class="hljs-regexp">/raw/m</span>aster<span class="hljs-regexp">/post-precompile.sh | sed  &#x27;s/</span>\r<span class="hljs-regexp">//</span><span class="hljs-string">&#x27; |  bash -s -- -ap /apps/nginx-1.22.0 -s &quot;./sbin/nginx -g &#x27;</span>daemon off;<span class="hljs-string">&#x27;&quot;</span><br></code></pre></td></tr></table></figure>

<h3 id="添加模块"><a href="#添加模块" class="headerlink" title="添加模块"></a>添加模块</h3><h4 id="echo模块"><a href="#echo模块" class="headerlink" title="echo模块"></a>echo模块</h4><p>编译方法: [ <a target="_blank" rel="noopener" href="https://github.com/openresty/echo-nginx-module#installation">https://github.com/openresty/echo-nginx-module#installation</a> ]</p>
<p>下载包: [ <a target="_blank" rel="noopener" href="https://github.com/openresty/echo-nginx-module/releases/tag/v0.62">https://github.com/openresty/echo-nginx-module/releases/tag/v0.62</a> ]</p>
<p>基于以上的编译二次编译</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">./configure  --prefix=/apps/nginx --user=nginx --group=nginx --with-compat --with-file-aio --with-threads --with-http_addition_module --with-http_auth_request_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_random_index_module --with-http_realip_module --with-http_secure_link_module --with-http_slice_module --with-http_ssl_module --with-http_stub_status_module --with-http_sub_module --with-http_v2_module --with-stream --with-stream_realip_module --with-stream_ssl_module --with-stream_ssl_preread_module --with-http_geoip_module=dynamic --with-stream_geoip_module=dynamic --add-module=/usr/local/src/echo-nginx-module-0.62/<br><br><br>make -j $(<span class="hljs-built_in">nproc</span>) &amp;&amp; make install -j $(<span class="hljs-built_in">nproc</span>)<br><br><br>nginx -V<br><br>systemctl restart nginx<br></code></pre></td></tr></table></figure>

<h4 id="ssl模块"><a href="#ssl模块" class="headerlink" title="ssl模块"></a>ssl模块</h4><p>引用自: [ <a target="_blank" rel="noopener" href="https://www.cnblogs.com/Oejfr/p/14902721.html">https://www.cnblogs.com/Oejfr/p/14902721.html</a> ]</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">wget https:<span class="hljs-regexp">//</span>www.openssl.org<span class="hljs-regexp">/source/</span>openssl-<span class="hljs-number">3.0</span>.<span class="hljs-number">5</span>.tar.gz<br></code></pre></td></tr></table></figure>

<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli"><span class="hljs-string">./configure</span>  <span class="hljs-params">--prefix=/apps/nginx</span> <span class="hljs-params">--user=nginx</span> <span class="hljs-params">--group=nginx</span> <span class="hljs-params">--with-compat</span> <span class="hljs-params">--with-file-aio</span> <span class="hljs-params">--with-threads</span> <span class="hljs-params">--with-http_addition_module</span> <span class="hljs-params">--with-http_auth_request_module</span> <span class="hljs-params">--with-http_gunzip_module</span> <span class="hljs-params">--with-http_gzip_static_module</span> <span class="hljs-params">--with-http_random_index_module</span> <span class="hljs-params">--with-http_realip_module</span> <span class="hljs-params">--with-http_secure_link_module</span> <span class="hljs-params">--with-http_slice_module</span> <span class="hljs-params">--with-http_ssl_module</span> <span class="hljs-params">--with-http_stub_status_module</span> <span class="hljs-params">--with-http_sub_module</span> <span class="hljs-params">--with-http_v2_module</span> <span class="hljs-params">--with-stream</span> <span class="hljs-params">--with-stream_realip_module</span> <span class="hljs-params">--with-stream_ssl_module</span> <span class="hljs-params">--with-stream_ssl_preread_module</span> <span class="hljs-params">--with-http_geoip_module=dynamic</span> <span class="hljs-params">--with-stream_geoip_module=dynamic</span>  <span class="hljs-params">--with-openssl=/root/openssl-3</span>.0.5<br><br>make -j $<span class="hljs-params">(nproc)</span> &amp;&amp; make install -j $<span class="hljs-params">(nproc)</span><br><br>nginx -V<br><br>systemctl restart nginx<br></code></pre></td></tr></table></figure>



<h1 id="作业"><a href="#作业" class="headerlink" title="作业"></a>作业</h1><ol>
<li>独立完成nginx yum安装，apt安装。</li>
<li>独立完成nginx制作rpm，添加echo模块，升级ssl，同时制作rpm。</li>
<li>独立完成nginx编译安装，添加echo模块，升级ssl。</li>
</ol>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/%E5%91%A8%E6%9C%AB%E7%9B%B4%E6%92%AD%E5%88%86%E4%BA%AB/">周末直播分享</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/linux/">linux</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">
                  
                    本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2022/07/31/Nginx%E9%80%9A%E7%94%A8%E9%85%8D%E7%BD%AE/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Nginx通用配置</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/06/12/vmware%E5%AE%89%E8%A3%85%E7%B3%BB%E7%BB%9F/">
                        <span class="hidden-mobile">Vmware安装系统</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
              <!-- Comments -->
              <article class="comments" id="comments" lazyload>
                
                  
                
                
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://cdn.jsdelivr.net/npm/valine@1/dist/Valine.min.js', function() {
        var options = Object.assign(
          {"appId":"D90Wrbg89ly7rBFpYHqsP64i-gzGzoHsz","appKey":"dcYNEdcRY3NGzaWBD9JDU4JM","path":"window.location.pathname","placeholder":"看完文章有什么建议呢","avatar":"retro","meta":["nick","mail","link"],"requiredFields":[],"pageSize":10,"lang":"zh-CN","highlight":true,"recordIP":true,"serverURLs":"https://d90wrbg8.lc-cn-n1-shared.com","emojiCDN":null,"emojiMaps":null,"enableQQ":false},
          {
            el: "#valine",
            path: window.location.pathname
          }
        )
        new Valine(options);
        Fluid.utils.waitElementVisible('#valine .vcontent', () => {
          Fluid.plugins.initFancyBox('#valine .vcontent img:not(.vemoji)');
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


              </article>
            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;TOC</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  

  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  <script  src="/js/local-search.js" ></script>



  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  
    <script  src="https://cdn.jsdelivr.net/npm/tocbot@4/dist/tocbot.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4/anchor.min.js" ></script>
  
  
    <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js" ></script>
  






  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
        typing(title);
      
    })(window, document);
  </script>












  

  

  

  

  
    <!-- 51.la Analytics -->
    <script defer type="text/javascript" src="//js.users.51.la/21348977.js"></script>
  

  





<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


</body>
</html>
